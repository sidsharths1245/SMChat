<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Shiv & Monika Chat</title>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
   * {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}
html, body {
  height: 100%;
  font-family: 'Segoe UI', Roboto, sans-serif;
  background: #f5f5f5;
  color: #111;
  transition: background 0.3s, color 0.3s;
}
body.dark {
  background: #121212;
  color: #eee;
}
#login-container {
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  height: 100%;
  max-width: 400px;
  margin: 0 auto;
  padding: 20px;
}
#login-container.hidden {
  display: none;
}
#login-container h1 {
  font-size: 24px;
  margin-bottom: 20px;
}
#login-container input {
  width: 100%;
  padding: 10px;
  margin: 10px 0;
  border-radius: 8px;
  border: 1px solid #ccc;
  font-size: 15px;
  outline: none;
}
body.dark #login-container input {
  background: #222;
  border: 1px solid #555;
  color: #eee;
}
#login-logo {
  width: 80px;
  height: auto;
  margin-bottom: 20px;
  display: block;
  transition: filter 0.3s;
}
body.dark #login-logo {
  filter: brightness(1.2);
}
#login-container button {
  width: 100%;
  padding: 12px;
  background: #0DB561;
  border: none;
  border-radius: 8px;
  font-size: 16px;
  cursor: pointer;
  transition: background 0.3s;
  color: #fff;
}
#login-container button:hover {
  background: #0C9F54;
}
body.dark #login-container button {
  background: #0DB561;
  color: #fff;
}
body.dark #login-container button:hover {
  background: #0C9F54;
}
#login-error {
  color: #d32f2f;
  font-size: 14px;
  margin-top: 10px;
  display: none;
}
#chat-header {
  position: sticky;
  top: 0;
  z-index: 2;
  background: transparent;
  font-size: 17px;
  padding: 16px 10px;
  text-align: center;
  font-weight: 600;
  color: #111;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
body.dark #chat-header {
  color: #fff;
}
#menu-button {
  background: none;
  border: none;
  font-size: 20px;
  cursor: pointer;
  color: #111;
}
body.dark #menu-button {
  color: #eee;
}
#menu {
  position: absolute;
  top: 50px;
  right: 10px;
  background: #fff;
  border-radius: 8px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.2);
  display: none;
  z-index: 3;
}
body.dark #menu {
  background: #2a2a2a;
}
#menu button {
  display: block;
  width: 100%;
  padding: 10px 20px;
  background: none;
  border: none;
  text-align: left;
  font-size: 14px;
  cursor: pointer;
  color: #111;
}
body.dark #menu button {
  color: #eee;
}
#menu button:hover {
  background: #f0f0f0;
}
body.dark #menu button:hover {
  background: #333;
}
#message-menu, #reaction-menu {
  position: absolute;
  background: #fff;
  border-radius: 8px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.2);
  display: none;
  z-index: 4;
  min-width: 250px;
  padding: 8px 0;
}
body.dark #message-menu, body.dark #reaction-menu {
  background: #2a2a2a;
}
#message-menu .emoji-row {
  display: flex;
  flex-direction: row;
  align-items: center;
  padding: 8px 12px;
  gap: 5px;
}
#message-menu .emoji-button {
  font-size: 18px;
  background: none;
  border: none;
  cursor: pointer;
  padding: 2px;
  width: 30px;
  text-align: center;
}
#message-menu .emoji-button:hover {
  transform: scale(1.2);
}
#message-menu .more-emojis {
  font-size: 18px;
  background: none;
  border: none;
  cursor: pointer;
  padding: 5px;
  color: #111;
}
body.dark #message-menu .more-emojis {
  color: #eee;
}
#message-menu .more-emojis:hover {
  background: #f0f0f0;
}
body.dark #message-menu .more-emojis:hover {
  background: #333;
}
#message-menu button:not(.emoji-button):not(.more-emojis) {
  display: block;
  width: 100%;
  padding: 10px 20px;
  background: none;
  border: none;
  text-align: left;
  font-size: 14px;
  cursor: pointer;
  color: #111;
}
body.dark #message-menu button:not(.emoji-button):not(.more-emojis) {
  color: #eee;
}
#message-menu button:not(.emoji-button):not(.more-emojis):hover {
  background: #f0f0f0;
}
body.dark #message-menu button:not(.emoji-button):not(.more-emojis):hover {
  background: #333;
}
#reaction-menu button {
  display: block;
  width: 100%;
  padding: 10px 20px;
  background: none;
  border: none;
  text-align: left;
  font-size: 14px;
  cursor: pointer;
  color: #111;
}
body.dark #reaction-menu button {
  color: #eee;
}
#reaction-menu button:hover {
  background: #f0f0f0;
}
body.dark #reaction-menu button:hover {
  background: #333;
}
#more-emojis-menu {
  position: absolute;
  background: #fff;
  border-radius: 8px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.2);
  display: none;
  z-index: 5;
  min-width: 150px;
  padding: 8px;
}
body.dark #more-emojis-menu {
  background: #2a2a2a;
}
#more-emojis-menu button {
  font-size: 18px;
  background: none;
  border: none;
  cursor: pointer;
  padding: 5px;
  width: 30px;
  text-align: center;
  display: inline-block;
}
#more-emojis-menu button:hover {
  transform: scale(1.2);
}
#typing {
  font-size: 12px;
  text-align: center;
  color: #999;
  margin: 4px 0;
  height: 16px;
}
#chat-container {
  display: flex;
  flex-direction: column;
  height: 100%;
  max-width: 600px;
  margin: 0 auto;
  padding: 0 10px;
}
#chat-container.hidden {
  display: none;
}
#messages {
  flex: 1;
  overflow-y: auto;
  padding: 10px 0;
  display: flex;
  flex-direction: column;
  gap: 8px;
}
.msg-row {
  display: flex;
  position: relative;
  transition: transform 0.2s ease-out;
}
.msg-row.swiping {
  transform: translateX(0);
}
.left {
  justify-content: flex-start;
}
.right {
  justify-content: flex-end;
}
.msg {
  padding: 10px 14px;
  border-radius: 20px;
  max-width: 75%;
  font-size: 15px;
  word-wrap: break-word;
  position: relative;
  line-height: 1.4;
  background: #fff;
  color: #111;
  box-shadow: 0 1px 4px rgba(0,0,0,0.08);
}
.left .msg {
  background: #f0f0f0;
}
.right .msg {
  background: #dcf8c6;
}
body.dark .msg {
  background: #2a2a2a;
  color: #eee;
}
body.dark .left .msg {
  background: #1f1f1f;
}
body.dark .right .msg {
  background: #303d2f;
}
.timestamp {
  font-size: 11px;
  text-align: right;
  margin-top: 4px;
  color: #888;
}
.reaction-bar {
  position: absolute;
  top: -30px;
  background: #f8f8f8;
  border-radius: 20px;
  padding: 6px 12px;
  box-shadow: 0 2px 5px rgba(0,0,0,0.15);
  border: 1px solid #ddd;
  display: none;
  z-index: 3;
  flex-direction: row;
  transition: background 0.2s;
}
.reaction-bar:hover {
  background: #f0f0f0;
}
.left .reaction-bar {
  left: 10px;
}
.right .reaction-bar {
  right: 10px;
}
body.dark .reaction-bar {
  background: #2a2a2a;
  border: 1px solid #555;
}
body.dark .reaction-bar:hover {
  background: #333;
}
.reaction-bar span {
  font-size: 18px;
  margin: 0 5px;
  cursor: pointer;
}
.reaction-bar span:hover {
  transform: scale(1.2);
}
.reactions {
  position: absolute;
  bottom: -7px;
  font-size: 14px;
  display: flex;
  gap: 2px;
  flex-wrap: wrap;
  padding: 2px 6px;
  border-radius: 10px;
  background: #fff;
  box-shadow: 0 1px 3px rgba(0,0,0,0.2);
  cursor: pointer;
  transition: background 0.2s;
}
.left .reactions {
  left: 10px;
}
.right .reactions {
  right: 10px;
}
body.dark .reactions {
  background: #2a2a2a;
  box-shadow: 0 1px 3px rgba(0,0,0,0.3);
}
body.dark .reactions:hover {
  background: #333;
}
.reactions span {
  line-height: 1;
}
#input-area {
  position: sticky;
  bottom: 0;
  background: transparent;
  display: flex;
  flex-direction: column;
  gap: 6px;
  padding: 12px 0;
}
#reply-preview {
  display: none;
  padding: 10px 12px;
  font-size: 14px;
  background: #e8ecef;
  border-radius: 8px;
  border-left: 4px solid #007bff;
  margin-bottom: 8px;
  position: relative;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  transition: background 0.3s;
}
body.dark #reply-preview {
  background: #2c3034;
  border-color: #4da8ff;
  color: #d1d5db;
}
#reply-preview span#reply-text {
  display: block;
  max-width: 85%;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  color: #333;
  font-weight: 500;
}
body.dark #reply-preview span#reply-text {
  color: #d1d5db;
}
#reply-preview span#prefix-text {
  font-size: 12px;
  color: #666;
  margin-bottom: 4px;
  display: block;
}
body.dark #reply-preview span#prefix-text {
  color: #9ca3af;
}
#cancel-reply, #cancel-edit {
  position: absolute;
  right: 12px;
  top: 50%;
  transform: translateY(-50%);
  cursor: pointer;
  font-size: 16px;
  font-weight: bold;
  color: #666;
  padding: 4px;
  border-radius: 50%;
  transition: color 0.2s, background 0.2s;
}
#cancel-reply:hover, #cancel-edit:hover {
  color: #333;
  background: rgba(0,0,0,0.1);
}
body.dark #cancel-reply, body.dark #cancel-edit {
  color: #9ca3af;
}
body.dark #cancel-reply:hover, body.dark #cancel-edit:hover {
  color: #d1d5db;
  background: rgba(255,255,255,0.1);
}
#cancel-edit {
  right: 36px;
}
.input-row {
  display: flex;
  align-items: center;
  gap: 10px;
}
#message {
  flex: 1;
  padding: 10px 14px;
  font-size: 15px;
  border-radius: 18px;
  border: 1px solid #ccc;
  outline: none;
  background: #fff;
  transition: 0.3s;
  resize: none;
  min-height: 22px;
  line-height: 1.4;
  font-family: 'Segoe UI', Roboto, sans-serif;
  overflow: hidden;
}
body.dark #message {
  background: #222;
  border: 1px solid #555;
  color: #eee;
}
button.send-button {
  background: #0DB561;
  border: none;
  color: #fff;
  border-radius: 50%;
  width: 44px;
  height: 44px;
  font-size: 24px;
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  cursor: pointer;
  transition: background 0.3s;
  display: flex;
  align-items: center;
  justify-content: center;
}
button.send-button:hover {
  background: #0C9F54;
}
button.send-button.edit-mode {
  background: #0B8C48;
  color: #fff;
}
button.send-button.edit-mode:hover {
  background: #0A7A3F;
}
#messages > div[style*="text-align: center"] {
  font-size: 11px;
  color: #aaa;
}
@media (max-width: 600px) {
  #chat-header {
    font-size: 16px;
  }
  .msg {
    font-size: 14px;
    padding: 9px 12px;
  }
  button.send-button {
    width: 40px;
    height: 40px;
    font-size: 20px;
  }
  .reaction-bar {
    top: -25px;
    padding: 5px 10px;
  }
  .reaction-bar span {
    font-size: 16px;
    margin: 0 3px;
  }
  .reactions {
    bottom: -7px;
    padding: 2px 6px;
    font-size: 14px;
  }
  #message-menu .emoji-row {
    display: flex;
    flex-direction: row;
    align-items: center;
    padding: 8px 12px;
    gap: 5px;
  }
  #message-menu .emoji-button {
    font-size: 16px;
    padding: 2px;
    width: 28px;
  }
  #message {
    min-height: 40px;
  }
  #login-logo {
    width: 80px;
    margin-bottom: 15px;
  }
}
.reply-to {
  font-size: 12px;
  color: #666;
  border-left: 3px solid #ccc;
  padding-left: 8px;
  margin-bottom: 6px;
}
  </style>
</head>
<body>
  <div id="login-container">
    <img src="https://raw.githubusercontent.com/sidsharths1245/SMChat/refs/heads/main/logo.png" alt="Chat Logo" id="login-logo" />
    <h1>Login to Chat</h1>
    <input id="username" placeholder="Username" />
    <input id="pin" type="password" placeholder="PIN" />
    <button onclick="login()">Login</button>
    <div id="login-error">Invalid username or PIN</div>
  </div>
  <div id="chat-container" class="hidden">
    <div id="chat-header">
      <span id="chat-with"></span>
      <div>
        <button id="menu-button">⋮</button>
        <div id="menu">
          <button id="theme-toggle" onclick="toggleTheme()"></button>
          <button onclick="logout()">Logout</button>
        </div>
      </div>
    </div>
    <div id="typing"></div>
    <div id="messages"></div>
    <div id="input-area">
      <div id="reply-preview">
        <span id="prefix-text"></span>
        <span id="reply-text"></span>
        <span id="cancel-reply">×</span>
        <span id="cancel-edit">×</span>
      </div>
      <div class="input-row">
        <textarea id="message" placeholder="Type a message" autocomplete="off"></textarea>
        <button class="send-button" onclick="sendOrEditMessage()"><span class="material-icons">send</span></button>
      </div>
    </div>
  </div>
  <audio id="notify-sound" src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_846a730e18.mp3" preload="auto"></audio>

  <script type="module">
  if (Notification.permission !== "granted") {
    Notification.requestPermission();
  }

  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
  import {
    getDatabase, ref, push, onChildAdded, onChildChanged, onChildRemoved, onValue, set, remove, update
  } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyC3ewLzG9uzaie20gvJIsliDXnU4k2VjqM",
    authDomain: "chat-b6996.firebaseapp.com",
    databaseURL: "https://chat-b6996-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "chat-b6996",
    storageBucket: "chat-b6996.appspot.com",
    messagingSenderId: "859974637172",
    appId: "1:859974637172:web:8f7db61698bec9f081e321"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const messagesRef = ref(db, "messages");
  const typingRef = ref(db, "typing");
  const readRef = ref(db, "readReceipts");

  let currentUser = localStorage.getItem("currentUser") || null;
  let lastMessageId = null;
  let replyTo = null;
  let editingMessageId = null;

  const validUsers = {
    "Shiv": "1234",
    "Monika": "5678"
  };

  const defaultEmojis = ['😊', '👍', '❤️', '😂', '😢'];
  const moreEmojis = ['😎', '🙌', '😍', '😜', '😡'];

  if (localStorage.getItem("theme") === "dark") {
    document.body.classList.add("dark");
  }
  updateThemeButtonText();

  if (currentUser && validUsers[currentUser]) {
    showChat();
    updateHeader();
    startMessageListener();
  } else {
    showLogin();
  }

  function showLogin() {
    document.getElementById("login-container").classList.remove("hidden");
    document.getElementById("chat-container").classList.add("hidden");
  }

  function showChat() {
    document.getElementById("login-container").classList.add("hidden");
    document.getElementById("chat-container").classList.remove("hidden");
  }

  function login() {
    const usernameInput = document.getElementById("username").value.trim();
    const pin = document.getElementById("pin").value.trim();
    const errorDiv = document.getElementById("login-error");

    const username = usernameInput.charAt(0).toUpperCase() + usernameInput.slice(1).toLowerCase();

    if (validUsers[username] && validUsers[username] === pin) {
      currentUser = username;
      localStorage.setItem("currentUser", username);
      errorDiv.style.display = "none";
      showChat();
      updateHeader();
      startMessageListener();
    } else {
      errorDiv.style.display = "block";
    }
  }

  function logout() {
    localStorage.removeItem("currentUser");
    currentUser = null;
    editingMessageId = null;
    document.getElementById("menu").style.display = "none";
    showLogin();
    document.getElementById("username").value = "";
    document.getElementById("pin").value = "";
    document.getElementById("messages").innerHTML = "";
  }

  function toggleTheme() {
    document.body.classList.toggle("dark");
    localStorage.setItem("theme", document.body.classList.contains("dark") ? "dark" : "light");
    updateThemeButtonText();
    document.getElementById("menu").style.display = "none";
  }

  function updateThemeButtonText() {
    const themeButton = document.getElementById("theme-toggle");
    themeButton.textContent = document.body.classList.contains("dark") ? "Switch to Light Mode" : "Switch to Dark Mode";
  }

  function updateHeader() {
    document.getElementById("chat-with").textContent =
      currentUser === "Monika" ? "Chatting with Shiv" : "Chatting with Monika";
  }

  document.getElementById("menu-button").onclick = () => {
    const menu = document.getElementById("menu");
    menu.style.display = menu.style.display === "block" ? "none" : "block";
  };

  document.addEventListener("click", (e) => {
    const menu = document.getElementById("menu");
    const menuButton = document.getElementById("menu-button");
    const messageMenu = document.getElementById("message-menu");
    const moreEmojisMenu = document.getElementById("more-emojis-menu");
    const messageInput = document.getElementById("message");

    // Hide menus if clicking outside
    if (!menu.contains(e.target) && !menuButton.contains(e.target)) {
      menu.style.display = "none";
    }
    if (messageMenu && !messageMenu.contains(e.target) && (!moreEmojisMenu || !moreEmojisMenu.contains(e.target))) {
      messageMenu.style.display = "none";
    }
    if (moreEmojisMenu && !moreEmojisMenu.contains(e.target) && !messageMenu.contains(e.target)) {
      moreEmojisMenu.style.display = "none";
    }

    // Hide keyboard if clicking outside the textarea
    if (!messageInput.contains(e.target) && !messageMenu.contains(e.target) && !moreEmojisMenu.contains(e.target)) {
      messageInput.blur();
    }
  });

  const messageInput = document.getElementById("message");
  messageInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && e.ctrlKey) {
      e.preventDefault();
      sendOrEditMessage();
    }
    set(typingRef, currentUser + " is typing...");
  });
  messageInput.addEventListener("keyup", (e) => {
    setTimeout(() => set(typingRef, ""), 1000);
  });

  // Handle back button to hide keyboard
  window.addEventListener("popstate", () => {
    const messageInput = document.getElementById("message");
    messageInput.blur();
  });

  function sendOrEditMessage() {
    const text = messageInput.value.trim();
    if (!text) return;

    if (editingMessageId) {
      const now = new Date();
      const time = now.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
      const messageRef = ref(db, `messages/${editingMessageId}`);
      update(messageRef, {
        text: text,
        time: time,
        edited: true,
        editedAt: now.toISOString()
      }).then(() => {
        console.log("Message updated successfully");
        clearEdit();
        messageInput.focus(); // Keep focus after editing
      }).catch((error) => {
        console.error("Error updating message:", error);
        alert("Failed to edit message. Please check your permissions or try again.");
      });
      return;
    }

    if (text === "#clear") {
      remove(messagesRef).catch((error) => {
        console.error("Error clearing messages:", error);
      });
      remove(readRef).catch((error) => {
        console.error("Error clearing read receipts:", error);
      });
      messageInput.value = "";
      document.getElementById("messages").innerHTML = "";
      messageInput.focus(); // Keep focus after clearing
      return;
    }
    if (text === "#dark") {
      document.body.classList.add("dark");
      localStorage.setItem("theme", "dark");
      updateThemeButtonText();
      messageInput.value = "";
      messageInput.focus(); // Keep focus after theme change
      return;
    }
    if (text === "#light") {
      document.body.classList.remove("dark");
      localStorage.setItem("theme", "light");
      updateThemeButtonText();
      messageInput.value = "";
      messageInput.focus(); // Keep focus after theme change
      return;
    }

    const now = new Date();
    const time = now.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });

    push(messagesRef, {
      name: currentUser,
      text,
      time,
      timeDate: now.toISOString(),
      reply: replyTo,
      reactions: {}
    }).catch((error) => {
      console.error("Error sending message:", error);
    });

    messageInput.value = "";
    set(typingRef, "").catch((error) => {
      console.error("Error clearing typing status:", error);
    });
    clearReply();
    messageInput.focus(); // Keep focus after sending
  }

  function editMessage(msgId, msgText) {
    editingMessageId = msgId;
    messageInput.value = msgText;
    messageInput.focus();
    const sendButton = document.querySelector(".send-button");
    sendButton.classList.add("edit-mode");
    sendButton.innerHTML = '<span class="material-icons">check</span>';
    document.getElementById("reply-preview").style.display = "block";
    document.getElementById("prefix-text").textContent = "Editing message";
    document.getElementById("reply-text").textContent = msgText;
    document.getElementById("cancel-edit").style.display = "inline";
    document.getElementById("cancel-reply").style.display = "none";
  }

  function clearEdit() {
    editingMessageId = null;
    messageInput.value = "";
    const sendButton = document.querySelector(".send-button");
    sendButton.classList.remove("edit-mode");
    sendButton.innerHTML = '<span class="material-icons">send</span>';
    document.getElementById("reply-preview").style.display = "none";
    document.getElementById("prefix-text").textContent = "";
    document.getElementById("reply-text").textContent = "";
    document.getElementById("cancel-edit").style.display = "none";
    document.getElementById("cancel-reply").style.display = "inline";
    messageInput.focus(); // Keep focus after clearing edit
  }

  function deleteMessage(msgId, forEveryone = false) {
    const messageRef = ref(db, `messages/${msgId}`);
    if (forEveryone) {
      remove(messageRef).then(() => {
        console.log("Message deleted for everyone");
      }).catch((error) => {
        console.error("Error deleting message for everyone:", error);
        alert("Failed to delete message for everyone. Please check your permissions or try again.");
      });
    } else {
      update(messageRef, { 
        text: "This message was deleted",
        deleted: true,
        deletedBy: currentUser,
        deletedAt: new Date().toISOString()
      }).then(() => {
        console.log("Message marked as deleted for me");
      }).catch((error) => {
        console.error("Error marking message as deleted:", error);
        alert("Failed to delete message for me. Please check your permissions or try again.");
      });
    }
    messageInput.focus(); // Keep focus after deleting
  }

  function clearReply() {
    replyTo = null;
    document.getElementById("reply-preview").style.display = "none";
    document.getElementById("prefix-text").textContent = "";
    document.getElementById("reply-text").textContent = "";
    document.getElementById("cancel-reply").style.display = "inline";
    document.getElementById("cancel-edit").style.display = "none";
    messageInput.focus(); // Keep focus after clearing reply
  }

  document.getElementById("cancel-reply").onclick = clearReply;
  document.getElementById("cancel-edit").onclick = clearEdit;

  function updateReadReceipt(msgId) {
    if (document.visibilityState === "visible") {
      update(readRef, { [currentUser]: msgId }).catch((error) => {
        console.error("Error updating read receipt:", error);
      });
    }
  }

  function renderSeenIndicator(msgId) {
    onValue(readRef, (snapshot) => {
      const reads = snapshot.val() || {};
      const otherUser = currentUser === "Shiv" ? "Monika" : "Shiv";
      if (reads[otherUser] === msgId) {
        const lastBubble = document.querySelector(`.msg-row.right[data-id="${msgId}"] .timestamp`);
        if (lastBubble && !lastBubble.textContent.includes("✓")) {
          lastBubble.textContent += " ✓ Seen";
        }
      }
    });
  }

  function getDateLabel(dateStr) {
    const msgDate = new Date(dateStr);
    const now = new Date();
    const isToday = msgDate.toDateString() === now.toDateString();
    const yesterday = new Date(now);
    yesterday.setDate(now.getDate() - 1);
    if (isToday) return "Today";
    if (msgDate.toDateString() === yesterday.toDateString()) return "Yesterday";
    return msgDate.toLocaleDateString(undefined, { day: 'numeric', month: 'short', year: 'numeric' });
  }

  function addReaction(msgId, emoji) {
    const reactionRef = ref(db, `messages/${msgId}/reactions/${currentUser}`);
    set(reactionRef, emoji).then(() => {
      console.log("Reaction added successfully");
    }).catch((error) => {
      console.error("Error adding reaction:", error);
      alert("Failed to add reaction. Please check your permissions or try again.");
    });
    messageInput.focus(); // Keep focus after adding reaction
  }

  function removeReaction(msgId) {
    const reactionRef = ref(db, `messages/${msgId}/reactions/${currentUser}`);
    remove(reactionRef).then(() => {
      console.log("Reaction removed successfully");
    }).catch((error) => {
      console.error("Error removing reaction:", error);
      alert("Failed to remove reaction. Please check your permissions or try again.");
    });
    messageInput.focus(); // Keep focus after removing reaction
  }

  function renderReactions(bubble, msgId, reactions) {
    let reactionDiv = bubble.querySelector('.reactions');
    if (!reactionDiv) {
      reactionDiv = document.createElement('div');
      reactionDiv.className = 'reactions';
      bubble.appendChild(reactionDiv);
    }
    reactionDiv.innerHTML = '';

    if (reactions && Object.keys(reactions).length > 0) {
      const emojiCounts = {};
      for (const emoji of Object.values(reactions)) {
        emojiCounts[emoji] = (emojiCounts[emoji] || 0) + 1;
      }
      for (const [emoji, count] of Object.entries(emojiCounts)) {
        const reactionSpan = document.createElement('span');
        reactionSpan.textContent = count > 1 ? `${emoji}${count}` : emoji;
        reactionSpan.setAttribute('data-emoji', emoji);
        reactionSpan.onclick = (e) => {
          e.stopPropagation();
          showReactionMenu(e, msgId, emoji, reactions);
        };
        reactionDiv.appendChild(reactionSpan);
      }
      reactionDiv.style.display = 'flex';
    } else {
      reactionDiv.style.display = 'none';
    }
  }

  function showReactionMenu(e, msgId, selectedEmoji, reactions) {
    e.stopPropagation();
    let messageMenu = document.getElementById("message-menu");
    if (!messageMenu) {
      messageMenu = document.createElement("div");
      messageMenu.id = "message-menu";
      document.body.appendChild(messageMenu);
    }
    messageMenu.innerHTML = '';

    const users = Object.entries(reactions).filter(([_, emoji]) => emoji === selectedEmoji).map(([user]) => user);
    if (users.length > 0) {
      const usersButton = document.createElement("button");
      usersButton.textContent = `Reacted by: ${users.join(', ')}`;
      usersButton.style.cursor = 'default';
      messageMenu.appendChild(usersButton);
    }

    if (reactions[currentUser]) {
      const removeButton = document.createElement("button");
      removeButton.textContent = "Remove Reaction";
      removeButton.onclick = () => {
        removeReaction(msgId);
        messageMenu.style.display = "none";
      };
      messageMenu.appendChild(removeButton);
    }

    const emojiRow = document.createElement("div");
    emojiRow.className = "emoji-row";
    defaultEmojis.forEach(emoji => {
      const emojiButton = document.createElement("button");
      emojiButton.textContent = emoji;
      emojiButton.className = "emoji-button";
      emojiButton.onclick = () => {
        addReaction(msgId, emoji);
        messageMenu.style.display = "none";
      };
      emojiRow.appendChild(emojiButton);
    });

    const moreButton = document.createElement("button");
    moreButton.textContent = "➡️";
    moreButton.className = "more-emojis";
    moreButton.onclick = (e) => {
      e.stopPropagation();
      showMoreEmojisMenu(e, msgId);
      messageMenu.style.display = "none";
    };
    emojiRow.appendChild(moreButton);
    messageMenu.appendChild(emojiRow);

    const rect = e.target.getBoundingClientRect();
    const msgRow = e.target.closest('.msg-row');
    const isRightAligned = msgRow.classList.contains('right');
    const menuWidth = messageMenu.offsetWidth || 250;
    const viewportWidth = window.innerWidth;
    let leftPos = isRightAligned ? (rect.left + window.scrollX - menuWidth) : (rect.right + window.scrollX + 5);

    if (leftPos + menuWidth > viewportWidth) {
      leftPos = viewportWidth - menuWidth - 10;
    }
    if (leftPos < 0) {
      leftPos = 10;
    }

    messageMenu.style.top = `${rect.bottom + window.scrollY + 5}px`;
    messageMenu.style.left = `${leftPos}px`;
    messageMenu.style.display = "block";
  }

  function showMoreEmojisMenu(e, msgId) {
    e.stopPropagation();
    let moreEmojisMenu = document.getElementById("more-emojis-menu");
    if (!moreEmojisMenu) {
      moreEmojisMenu = document.createElement("div");
      moreEmojisMenu.id = "more-emojis-menu";
      document.body.appendChild(moreEmojisMenu);
    }
    moreEmojisMenu.innerHTML = '';
    moreEmojisMenu.style.display = "none";

    moreEmojis.forEach(emoji => {
      const emojiButton = document.createElement("button");
      emojiButton.textContent = emoji;
      emojiButton.onclick = (e) => {
        e.stopPropagation();
        addReaction(msgId, emoji);
        moreEmojisMenu.style.display = "none";
      };
      moreEmojisMenu.appendChild(emojiButton);
    });

    moreEmojisMenu.style.visibility = "hidden";
    moreEmojisMenu.style.display = "block";
    const menuWidth = moreEmojisMenu.offsetWidth || 150;
    moreEmojisMenu.style.visibility = "visible";
    moreEmojisMenu.style.display = "none";

    const rect = e.target.getBoundingClientRect();
    const msgRow = e.target.closest('.msg-row') || document.querySelector(`.msg-row[data-id="${msgId}"]`);
    const isRightAligned = msgRow ? msgRow.classList.contains('right') : false;
    const viewportWidth = window.innerWidth;
    let leftPos = isRightAligned ? (rect.left + window.scrollX - menuWidth) : (rect.right + window.scrollX + 5);

    if (leftPos + menuWidth > viewportWidth) {
      leftPos = viewportWidth - menuWidth - 10;
    }
    if (leftPos < 0) {
      leftPos = 10;
    }

    moreEmojisMenu.style.top = `${rect.bottom + window.scrollY + 5}px`;
    moreEmojisMenu.style.left = `${leftPos}px`;
    moreEmojisMenu.style.display = "block";
  }

  function showMessageMenu(e, msgId, msgText, isCurrentUser) {
    e.preventDefault();
    e.stopPropagation();
    let messageMenu = document.getElementById("message-menu");
    if (!messageMenu) {
      messageMenu = document.createElement("div");
      messageMenu.id = "message-menu";
      document.body.appendChild(messageMenu);
    }
    messageMenu.innerHTML = '';

    const emojiRow = document.createElement("div");
    emojiRow.className = "emoji-row";
    defaultEmojis.forEach(emoji => {
      const emojiButton = document.createElement("button");
      emojiButton.textContent = emoji;
      emojiButton.className = "emoji-button";
      emojiButton.onclick = () => {
        addReaction(msgId, emoji);
        messageMenu.style.display = "none";
      };
      emojiRow.appendChild(emojiButton);
    });

    const moreButton = document.createElement("button");
    moreButton.textContent = "➡️";
    moreButton.className = "more-emojis";
    moreButton.onclick = (e) => {
      e.stopPropagation();
      showMoreEmojisMenu(e, msgId);
      messageMenu.style.display = "none";
    };
    emojiRow.appendChild(moreButton);
    messageMenu.appendChild(emojiRow);

    if (isCurrentUser) {
      const editButton = document.createElement("button");
      editButton.textContent = "Edit Message";
      editButton.onclick = () => {
        editMessage(msgId, msgText);
        messageMenu.style.display = "none";
      };
      messageMenu.appendChild(editButton);

      const deleteForMeButton = document.createElement("button");
      deleteForMeButton.textContent = "Delete for Me";
      deleteForMeButton.onclick = () => {
        deleteMessage(msgId, false);
        messageMenu.style.display = "none";
      };
      messageMenu.appendChild(deleteForMeButton);

      const deleteForEveryoneButton = document.createElement("button");
      deleteForEveryoneButton.textContent = "Delete for Everyone";
      deleteForEveryoneButton.onclick = () => {
        deleteMessage(msgId, true);
        messageMenu.style.display = "none";
      };
      messageMenu.appendChild(deleteForEveryoneButton);
    }

    const replyButton = document.createElement("button");
    replyButton.textContent = "Reply";
    replyButton.onclick = () => {
      replyTo = msgText;
      document.getElementById("prefix-text").textContent = "Replying to";
      document.getElementById("reply-text").textContent = msgText;
      document.getElementById("reply-preview").style.display = "block";
      document.getElementById("cancel-reply").style.display = "inline";
      document.getElementById("cancel-edit").style.display = "none";
      messageMenu.style.display = "none";
      messageInput.focus(); // Focus textarea after replying
    };
    messageMenu.appendChild(replyButton);

    const rect = e.target.getBoundingClientRect();
    const msgRow = e.target.closest('.msg-row');
    const isRightAligned = msgRow.classList.contains('right');
    const menuWidth = messageMenu.offsetWidth || 250;
    const viewportWidth = window.innerWidth;
    let leftPos = isRightAligned ? (rect.left + window.scrollX - menuWidth) : (rect.right + window.scrollX + 5);

    if (leftPos + menuWidth > viewportWidth) {
      leftPos = viewportWidth - menuWidth - 10;
    }
    if (leftPos < 0) {
      leftPos = 10;
    }

    messageMenu.style.top = `${rect.bottom + window.scrollY + 5}px`;
    messageMenu.style.left = `${leftPos}px`;
    messageMenu.style.display = "block";
  }

  function appendMessage(id, msg) {
    const isCurrentUser = msg.name === currentUser;
    const messages = document.getElementById("messages");

    const dateLabel = getDateLabel(msg.timeDate || new Date().toISOString());
    const lastDateLabel = messages.getAttribute("data-last-date");
    if (lastDateLabel !== dateLabel) {
      const dateDiv = document.createElement("div");
      dateDiv.textContent = dateLabel;
      dateDiv.style.textAlign = "center";
      dateDiv.style.fontSize = "12px";
      dateDiv.style.color = "#888";
      dateDiv.style.margin = "10px 0 4px";
      messages.appendChild(dateDiv);
      messages.setAttribute("data-last-date", dateLabel);
    }

    const msgRow = document.createElement("div");
    msgRow.className = "msg-row " + (isCurrentUser ? "right" : "left");
    msgRow.setAttribute("data-id", id);

    const bubble = document.createElement("div");
    bubble.className = "msg";
    if (msg.reply) {
      const replyDiv = document.createElement("div");
      replyDiv.className = "reply-to";
      replyDiv.textContent = msg.reply;
      bubble.appendChild(replyDiv);
    }

    const displayText = msg.deleted ? "This message was deleted" : msg.text;
    bubble.innerHTML += `
      <div>${displayText}${msg.edited ? ' <span style="font-size: 10px; color: #888;">(edited)</span>' : ''}</div>
      <div class="timestamp">${msg.time || ""}</div>
    `;

    renderReactions(bubble, id, msg.reactions);

    msgRow.appendChild(bubble);
    messages.appendChild(msgRow);
    messages.scrollTop = messages.scrollHeight;

    let touchTimer;
    let isSwiping = false;
    let touchStartX = 0;
    let touchStartY = 0;
    let touchCurrentX = 0;

    bubble.addEventListener("touchstart", (e) => {
      touchStartX = e.touches[0].clientX;
      touchStartY = e.touches[0].clientY;
      isSwiping = false;
      touchTimer = setTimeout(() => {
        if (!isSwiping) {
          showMessageMenu(e, id, msg.text, isCurrentUser);
        }
      }, 500);
    });

    bubble.addEventListener("touchmove", (e) => {
      touchCurrentX = e.touches[0].clientX;
      const touchCurrentY = e.touches[0].clientY;
      const deltaX = touchCurrentX - touchStartX;
      const deltaY = touchCurrentY - touchStartY;

      if (Math.abs(deltaX) > 20 && Math.abs(deltaX) > Math.abs(deltaY)) {
        isSwiping = true;
        msgRow.classList.add("swiping");
        if (Math.abs(deltaX) < 100) {
          msgRow.style.transform = `translateX(${deltaX}px)`;
        }
      }
    });

    bubble.addEventListener("touchend", (e) => {
      clearTimeout(touchTimer);
      if (isSwiping) {
        const deltaX = touchCurrentX - touchStartX;
        msgRow.classList.remove("swiping");
        msgRow.style.transform = "translateX(0)";
        if (Math.abs(deltaX) > 50) {
          replyTo = msg.text;
          document.getElementById("prefix-text").textContent = "Replying to";
          document.getElementById("reply-text").textContent = msg.text;
          document.getElementById("reply-preview").style.display = "block";
          document.getElementById("cancel-reply").style.display = "inline";
          document.getElementById("cancel-edit").style.display = "none";
          messageInput.focus(); // Focus textarea after swiping to reply
        }
      }
    });

    bubble.addEventListener("contextmenu", (e) => {
      showMessageMenu(e, id, msg.text, isCurrentUser);
    });

    if (!isCurrentUser) updateReadReceipt(id);
    else renderSeenIndicator(id);

    onValue(ref(db, `messages/${id}/reactions`), (snapshot) => {
      const reactions = snapshot.val() || {};
      renderReactions(bubble, id, reactions);
    });
  }

  function startMessageListener() {
    const messages = document.getElementById("messages");
    messages.innerHTML = "";
    messages.setAttribute("data-last-date", "");

    onValue(messagesRef, (snapshot) => {
      messages.innerHTML = "";
      messages.setAttribute("data-last-date", "");
      if (snapshot.exists()) {
        snapshot.forEach((child) => {
          appendMessage(child.key, child.val());
        });
      }
      messages.scrollTop = messages.scrollHeight;
    }, { onlyOnce: true });

    onChildAdded(messagesRef, (data) => {
      const msg = data.val();
      const isFromOtherUser = msg.name !== currentUser;

      if (!document.querySelector(`.msg-row[data-id="${data.key}"]`)) {
        appendMessage(data.key, msg);

        if (lastMessageId !== data.key && isFromOtherUser) {
          document.getElementById("notify-sound").play();

          if (document.visibilityState !== "visible" && Notification.permission === "granted") {
            new Notification(`New message from ${msg.name}`, {
              body: msg.text,
              icon: "https://cdn-icons-png.flaticon.com/512/1077/1077012.png"
            });
          }
        }

        lastMessageId = data.key;
      }
    });

    onChildChanged(messagesRef, (data) => {
      const msg = data.val();
      const msgRow = document.querySelector(`.msg-row[data-id="${data.key}"]`);
      if (msgRow) {
        const bubble = msgRow.querySelector(".msg");
        bubble.innerHTML = "";
        if (msg.reply) {
          const replyDiv = document.createElement("div");
          replyDiv.className = "reply-to";
          replyDiv.textContent = msg.reply;
          bubble.appendChild(replyDiv);
        }
        const displayText = msg.deleted ? "This message was deleted" : msg.text;
        bubble.innerHTML += `
          <div>${displayText}${msg.edited ? ' <span style="font-size: 10px; color: #888;">(edited)</span>' : ''}</div>
          <div class="timestamp">${msg.time || ""}</div>
        `;
        renderReactions(bubble, data.key, msg.reactions || {});
        if (msg.name === currentUser) {
          renderSeenIndicator(data.key);
        }
        messages.scrollTop = messages.scrollHeight;
      }
    });

    onChildRemoved(messagesRef, (data) => {
      const msgRow = document.querySelector(`.msg-row[data-id="${data.key}"]`);
      if (msgRow) {
        msgRow.remove();
      }
      const messagesDiv = document.getElementById("messages");
      const remainingMessages = messagesDiv.querySelectorAll(".msg-row");
      if (remainingMessages.length === 0) {
        messagesDiv.setAttribute("data-last-date", "");
      } else {
        messagesDiv.innerHTML = "";
        messagesDiv.setAttribute("data-last-date", "");
        onValue(messagesRef, (snapshot) => {
          if (snapshot.exists()) {
            snapshot.forEach((child) => {
              appendMessage(child.key, child.val());
            });
          }
          messages.scrollTop = messages.scrollHeight;
        }, { onlyOnce: true });
      }
    });
  }

  onValue(typingRef, (snapshot) => {
    document.getElementById("typing").textContent = snapshot.val() || "";
  });

  document.addEventListener("visibilitychange", () => {
    if (document.visibilityState === "visible" && currentUser) {
      startMessageListener();
    }
  });

  document.getElementById("pin").addEventListener("keydown", (e) => {
    if (e.key === "Enter") login();
  });

  window.sendOrEditMessage = sendOrEditMessage;
  window.login = login;
  window.logout = logout;
  window.toggleTheme = toggleTheme;
</script>
</body>
</html>
